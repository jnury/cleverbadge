generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  // shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  password_hash String
  role          UserRole @default(AUTHOR)
  created_at    DateTime @default(now())

  // Relations
  created_tests     Test[]     @relation("TestCreator")
  created_questions Question[] @relation("QuestionCreator")
}

enum UserRole {
  ADMIN
  AUTHOR
}

model Question {
  id              String   @id @default(uuid())
  content         String
  type            QuestionType
  options         Json?
  correct_answers Json?
  tags            String[]
  created_at      DateTime @default(now())
  created_by      String

  creator         User     @relation("QuestionCreator", fields: [created_by], references: [id])
  test_questions  TestQuestion[]
  answers         AssessmentAnswer[]
}

enum QuestionType {
  SINGLE
  MULTIPLE
}

model Test {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  created_by  String

  creator     User     @relation("TestCreator", fields: [created_by], references: [id])
  questions   TestQuestion[]
  assessments Assessment[]
}

model TestQuestion {
  test_id     String
  question_id String
  weight      Int      @default(1)

  test        Test     @relation(fields: [test_id], references: [id])
  question    Question @relation(fields: [question_id], references: [id])

  @@id([test_id, question_id])
}

model Assessment {
  id             String   @id @default(uuid())
  test_id        String
  candidate_name String
  score          Float?
  status         AssessmentStatus @default(STARTED)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  test           Test     @relation(fields: [test_id], references: [id])
  answers        AssessmentAnswer[]
}

enum AssessmentStatus {
  STARTED
  COMPLETED
}

model AssessmentAnswer {
  id               String   @id @default(uuid())
  assessment_id    String
  question_id      String
  selected_options Json

  assessment       Assessment @relation(fields: [assessment_id], references: [id])
  question         Question   @relation(fields: [question_id], references: [id])

  @@unique([assessment_id, question_id], name: "assessment_id_question_id")
}
