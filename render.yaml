projects:
  - name: Clever Badge
    environments:
      # =======================================================================
      # STAGING ENVIRONMENT
      # =======================================================================
      - name: staging
        services:
          # Staging Backend Service
          - type: web
            name: cleverbadge-backend-staging
            region: frankfurt
            branch: staging
            runtime: node
            plan: free
            rootDir: backend
            buildCommand: npm install
            startCommand: node index.js
            envVars:
              - key: DATABASE_URL
                sync: false  # Set manually with cleverbadge_staging user
              - key: NODE_ENV
                value: staging
              - key: JWT_SECRET
                sync: false  # Set manually in Render dashboard

          # Staging Frontend Service
          - type: web
            name: cleverbadge-frontend-staging
            branch: staging
            runtime: static
            rootDir: frontend
            buildCommand: npm ci && npm run build
            staticPublishPath: ./dist
            domains:
              - staging.cleverbadge.com
            envVars:
              - key: VITE_API_URL
                value: https://staging.cleverbadge.com
              - key: VITE_ENV
                value: staging
            routes:
              - type: rewrite
                source: /api/*
                destination: https://cleverbadge-backend-staging.onrender.com/api/*
              - type: rewrite
                source: /*
                destination: /index.html
            headers:
              - path: /*
                name: X-Frame-Options
                value: DENY
              - path: /*
                name: X-Content-Type-Options
                value: nosniff
              - path: /*
                name: X-XSS-Protection
                value: "1; mode=block"
              - path: /*
                name: Referrer-Policy
                value: strict-origin-when-cross-origin

          # Staging Migration Job (trigger manually before deployments)
          - type: cron
            schedule: "0 0 31 2 *"  # Feb 31st = never (trigger manually)
            name: cleverbadge-migrate-staging
            branch: staging
            region: frankfurt
            runtime: node
            rootDir: backend
            buildCommand: npm install
            startCommand: npm run migrate
            envVars:
              - key: DATABASE_ADMIN_URL
                sync: false  # Set manually with cleverbadge_staging_admin user
              - key: NODE_ENV
                value: staging

      # =======================================================================
      # PRODUCTION ENVIRONMENT
      # =======================================================================
      - name: production
        services:
          # Production Backend Service
          - type: web
            name: cleverbadge-backend-production
            branch: main
            region: frankfurt
            runtime: node
            plan: starter
            rootDir: backend
            buildCommand: npm install
            startCommand: node index.js
            envVars:
              - key: DATABASE_URL
                sync: false  # Set manually with cleverbadge_prod user
              - key: NODE_ENV
                value: production
              - key: JWT_SECRET
                sync: false  # Set manually in Render dashboard

          # Production Frontend Service
          - type: web
            name: cleverbadge-frontend-production
            branch: main
            runtime: static
            rootDir: frontend
            buildCommand: npm ci && npm run build
            staticPublishPath: ./dist
            domains:
              - cleverbadge.com
              - www.cleverbadge.com
            envVars:
              - key: VITE_API_URL
                value: https://cleverbadge.com
              - key: VITE_ENV
                value: production
            routes:
              - type: rewrite
                source: /api/*
                destination: https://cleverbadge-backend-production.onrender.com/api/*
              - type: rewrite
                source: /*
                destination: /index.html
            headers:
              - path: /*
                name: X-Frame-Options
                value: DENY
              - path: /*
                name: X-Content-Type-Options
                value: nosniff
              - path: /*
                name: X-XSS-Protection
                value: "1; mode=block"
              - path: /*
                name: Referrer-Policy
                value: strict-origin-when-cross-origin

          # Production Migration Job (trigger manually before deployments)
          - type: cron
            schedule: "0 0 31 2 *"  # Feb 31st = never (trigger manually)
            name: cleverbadge-migrate-production
            branch: main
            region: frankfurt
            runtime: node
            rootDir: backend
            buildCommand: npm install
            startCommand: npm run migrate
            envVars:
              - key: DATABASE_ADMIN_URL
                sync: false  # Set manually with cleverbadge_prod_admin user
              - key: NODE_ENV
                value: production

      # =======================================================================
      # SHARED ENVIRONMENT (Database + Cross-environment jobs)
      # =======================================================================
      - name: shared
        services:
          # Staging Database Refresh Job (trigger manually)
          # Copies production data to staging EXCEPT users (preserves staging admin accounts)
          - type: cron
            schedule: "0 0 31 2 *"  # Feb 31st = never (trigger manually)
            name: cleverbadge-refresh-db
            region: frankfurt
            runtime: node
            rootDir: backend
            buildCommand: npm install
            startCommand: npm run refresh_db
            envVars:
              - key: DATABASE_REFRESH_URL
                sync: false  # Set manually with cleverbadge_refresh user

        databases:
          # Shared PostgreSQL Database (with schema isolation)
          # Uses staging/production schemas within the same database
          - name: cleverbadge-db
            region: frankfurt
            databaseName: cleverbadge
            user: cleverbadge_superuser
            plan: basic-256mb
